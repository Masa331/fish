<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Fish</title>

    <style type="text/css" media="all">
html {
  box-sizing: border-box;
}
*, *:before, *:after {
  box-sizing: inherit;
}

      body {
        margin: 0;
        padding: 0;
        font-family: Monospace;
        font-size: 13px;
      }

      ul {
        list-style-type: none;
      }

      header nav {
        border-bottom: 1px solid lightgrey;
      }

      .inline-block {
        display: inline-block;
      }

      .margin-left-2rem {
        margin-left: 2rem;
      }
    </style>

    <script>
      // Events

      function backup() {
        const fileName = `fish_backup_${getIso8601Date(new Date())}.json`
        download(fileName, localStorage.getItem('fishEntries'));
      }

      function restore(event) {
        event.target.files[0].text()
          .then((result) => {
            localStorage.setItem('fishEntries', result);
            rerender();
          })
      }

      function addEntry(event) {
        event.preventDefault();

        const guid = uuidv4();
        const date = new Date();
        const rawDuration = event.target.duration.value;
        const duration = parseDuration(rawDuration);
        const rawDescription = event.target.description.value;
        const description = rawDescription + `. Raw duration: ${rawDuration}`;
        const tags = parseTags(description);

        saveEntry({ guid, date, duration, tags, description });
        rerender();
      }

      window.onload = rerender;

      // Private

      function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
      }

      function saveEntry(entry) {
        const newEntries = entries();
        newEntries.unshift(entry);

        localStorage.setItem('fishEntries', JSON.stringify(newEntries));
      }

      function entries() {
        const content = localStorage.getItem('fishEntries');

        if (content) {
          return JSON.parse(content);
        } else {
          return [];
        }
      }

      function clearEntries() {
        localStorage.clear();
      }

      function rerender() {
        const main = document.getElementsByTagName('main')[0];
        while (main.lastChild) {
          main.removeChild(main.lastChild);
        }

        const currentEntries = entries();
        const keyFunction = (item) => { return getIso8601Date(item['date']) };
        const groupedByDate = groupBy(currentEntries, keyFunction)

        for (key of Object.keys(groupedByDate)) {
          const dateRecords = groupedByDate[key];

          let byTag = {};
          for (record of dateRecords) {
            if (record.tags.length > 0) {
              for (tag of record.tags) {
                const grouping = byTag[tag] || { totalDuration: 0, records: [] };

                grouping.totalDuration = grouping.totalDuration + record.duration;
                grouping.records.push(record);
                byTag[tag] = grouping;
              }
            } else {
              const grouping = byTag['#other'] || { totalDuration: 0, records: [] };
              grouping.totalDuration = grouping.totalDuration + record.duration;
              grouping.records.push(record);
              byTag['#other'] = grouping;
            }
          }


          const tagComponents = Object.keys(byTag).map((tag) => {
            const record = byTag[tag];

            const newDay = new TagSummary();
            const descriptions = record.records.map((i) => {
              return `<p>${formatDuration(i.duration)} ${i.description}</p>`
            }).join('');

            newDay.innerHTML =
              `<span slot="tag-name">${tag}</span>
               <span slot="duration">${formatDuration(record.totalDuration)}</span>
               <span slot="records">${descriptions}</span>`

            return newDay;
          });


          const newDay = new OneDay();
          newDay.innerHTML = `<span slot="date">${getIso8601Date(key)}</span>`
          const ul = document.createElement('ul');
          const slotAttr = document.createAttribute('slot');
          slotAttr.value = 'tags';
          ul.setAttributeNode(slotAttr);
          tagComponents.forEach((component) => {
            ul.appendChild(component);
          });
          newDay.appendChild(ul);
          main.appendChild(newDay);
        }
      }

      function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      function parseDuration(raw) {
        if (raw.indexOf('s') > -1) {
          const value = raw.match(/\d*/)[0];
          return parseFloat(value);
        } else if (raw.indexOf('m') > -1) {
          const value = raw.match(/\d*/)[0];
          return parseFloat(value) * 60;
        } else if (raw.indexOf('h') > -1) {
          const value = raw.match(/\d*/)[0];
          return parseFloat(value) * 60 * 60;
        } else {
          return null;
        }
      }

      function parseTags(raw) {
        return Array.from(raw.matchAll(/#\w*/g));
      }

      function groupBy(array, keyFunction) {
        return array.reduce(function(memo, item) {
          const key = keyFunction(item);

          (memo[key] = memo[key] || []).push(item);

          return memo;
        }, {});
      };

      function getIso8601Date(date) {
        const parsedDate = new Date(date);
        return parsedDate.toISOString().slice(0,10);
      }

      function formatDuration(seconds) {
        if (seconds === null || seconds === undefined) {
          return '0s';
        } else if (seconds < 60) {
          return `${seconds}s`;
        } else if (seconds >= 60 && seconds < 3600) {
          return `${Math.round(seconds / 60)}m`;
        } else if (seconds >= 3600) {
          return `${parseFloat((seconds / 60 / 60).toFixed(2))}h`;
        } else {
          return '0s';
        }
      }

      class OneDay extends HTMLElement {
        constructor() {
          super();
          const template = document.getElementById('one-day-template').content;
          const shadowRoot = this.attachShadow({ mode: 'open' })
            .appendChild(template.cloneNode(true));
        }
      }
      customElements.define('one-day', OneDay);

      class TagSummary extends HTMLElement {
        constructor() {
          super();
          const template = document.getElementById('tag-summary-template').content;
          const shadowRoot = this.attachShadow({ mode: 'open' })
            .appendChild(template.cloneNode(true));
        }
      }
      customElements.define('tag-summary', TagSummary);
    </script>
  </head>
  <body>
    <template id="one-day-template">
      <section>
        <h1><slot name="date">date</slot></h1>
        <slot name="tags">tags</slot>
      </section>
    </template>
    <template id="tag-summary-template">
      <li>
        <details>
          <summary><slot name="tag-name">#abo</slot> <slot name="duration">2.5h</slot></summary>
          <slot name="records">
            <p>1h ahoj</p>
            <p>1.5h druhy</p>
          </slot>
        </details>
      </li>
    </template>

    <header>
      <nav>
        <h1 class="inline-block">Fish</h1>

        <form class="inline-block margin-left-2rem" onsubmit="addEntry(event)">
          <label for="duration">Duration</label>
          <input type="text" id="duration" name="duration" required>

          <label for="duration">Description</label>
          <input type="text" id="description" name="description" required>
          <button type="submit">Add</button>
        </form>

        <span class="margin-left-2rem">
          <button onclick="backup()">Backup</button>

          <label for="restore">Restore:</label>
          <input type="file" id="restore" name="restore" onchange="restore(event)">
        </span>
      </nav>
    </header>

    <main>
    </main>

    <noscript>
      This page doesn't run without Javascript.
    </noscript>
  </body>
</html>
